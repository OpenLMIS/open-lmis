<div ng-controller = "CreateRnrController" >
  <div ng-hide = "programRnRColumnList" >Loading...</div >
  <form name = "saveRnrForm" action = "#" id = "rnr-form" novalidate >
    <div class = "total-cost alert alert-info" >Total R&amp;R Cost:
      <span id = "totalCostCurrency" class = "cell-text" >
        {{currency}}
      </span >
      <span id = "totalCost" class = "cell-text" > {{rnr.fullSupplyItemsSubmittedCost}}
      </span >
    </div >
    <div class = "rnr-table" >
      <table class = "table table-striped table-bordered" >
        <thead >
          <tr >
            <th class = "col-{{programRnrColumn.name}}" ng-repeat = "programRnrColumn in programRnRColumnList"
                ng-hide = "programRnrColumn.name == 'quantityApproved'" >
              {{programRnrColumn.label}}
            </th >
          </tr >
        </thead >
        <tbody ng-show = "programRnRColumnList && (rnr.lineItems.length > 0)" >
          <tr ng-repeat = "rnrLineItem in rnrLineItems"
              ng-class = "getRowErrorClass(rnrLineItem,programRnRColumnList)" >
            <td class = "cell-input" ng-repeat = "column in programRnRColumnList"
                ng-hide = "column.name == 'quantityApproved'" >
              <ng-switch on = "column.source.name" >
                <span ng-switch-when = "USER_INPUT" >
                  <ng-switch on = "column.name" >
                    <span ng-switch-when = "beginningBalance"
                          ng-class = "getCellErrorClass(rnrLineItem, programRnRColumnList)" >
                      <ng-switch on = "rnrLineItem['previousStockInHandAvailable']" >
                        <span ng-switch-when = 'false' >
                          <input id = "{{getId('A', $parent.$parent)}}" type = "text"
                                 ng-required = "true" ng-disabled = "formDisabled"
                                 name = "beginningBalance{{rnrLineItem['id']}}"
                                 ng-model = "rnrLineItem[column.name]"
                                 rnr-validator = "positiveInteger" maxlength = "8"
                                 ng-change = "rnrLineItem.fill(rnr, programRnRColumnList)"
                                 ng-class = "highlightRequired(rnrLineItem[column.name])" /></span >
                        <span ng-switch-default >
                          <span class = "cell-text" ng-bind = "rnrLineItem[column.name]" ></span ></span >
                      </ng-switch >
                      <span class = "rnr-form-error" id = "beginningBalance{{rnrLineItem['id']}}"
                            style = "display:none;" >
                        Enter Numeric Data
                      </span >
                      <span class = "row-specific-error" ng-show = "rnrLineItem.getErrorMessage(programRnRColumnList)"
                            style = "background: red;" >
                        {{rnrLineItem.getErrorMessage(programRnRColumnList)}}
                        <span class = "beak-down" ></span >
                      </span >
                    </span >

                    <span ng-switch-when = "quantityReceived"
                          ng-class = "getCellErrorClass(rnrLineItem, programRnRColumnList)" >
                      <input ng-required = "true" ng-disabled = "formDisabled"
                             id = "{{getId('B', $parent)}}" type = "text"
                             name = "quantityReceived{{rnrLineItem['id']}}"
                             ng-model = "rnrLineItem[column.name]"
                             rnr-validator = "positiveInteger" maxlength = "8"
                             ng-change = "rnrLineItem.fill(rnr, programRnRColumnList)"
                             ng-class = "highlightRequired(rnrLineItem[column.name])" />
                      <span class = "rnr-form-error" id = "quantityReceived{{rnrLineItem['id']}}"
                            style = "display:none;" >
                        Enter Numeric Data
                      </span >
                      <span class = "row-specific-error" ng-show = "rnrLineItem.getErrorMessage(programRnRColumnList)"
                            style = "background: red;" >
                        {{rnrLineItem.getErrorMessage(programRnRColumnList)}}
                        <span class = "beak-down" ></span >
                      </span >
                    </span >

                    <span ng-switch-when = "quantityDispensed"
                          ng-class = "getCellErrorClass(rnrLineItem, programRnRColumnList)" >
                      <input ng-required = "true" ng-disabled = "formDisabled"
                             id = "{{getId('C', $parent)}}" type = "text"
                             name = "quantityDispensed{{rnrLineItem['id']}}"
                             ng-model = "rnrLineItem[column.name]"
                             rnr-validator = "positiveInteger"
                             ng-change = "rnrLineItem.fill(rnr, programRnRColumnList)"
                             maxlength = "8"
                             ng-class = "highlightRequired(rnrLineItem[column.name])" />
                      <span class = "rnr-form-error" id = "quantityDispensed{{rnrLineItem['id']}}"
                            style = "display:none;" >
                        Enter Numeric Data
                      </span >
                      <span class = "row-specific-error" ng-show = "rnrLineItem.getErrorMessage(programRnRColumnList)"
                            style = "background: red;" >
                        {{rnrLineItem.getErrorMessage(programRnRColumnList)}}
                        <span class = "beak-down" ></span >
                      </span >
                    </span >

                    <span ng-switch-when = "lossesAndAdjustments" >
                      <div id = "lossesAndAdjustments"
                           class = "fade ng-pristine ng-valid modal hide adjustments-modal" ui-modal
                           ng-model = "lossesAndAdjustmentsModal[rnrLineItem.id]"
                           data-backdrop = "static" data-keyboard = "false" >
                        <div class = "modal-header" ><h3 >Losses And Adjustments</h3 ></div >
                        <div class = "modal-body" >
                          <div class = "adjustment-field" >
                            <h5 >Add new Loss/Adjustment</h5 >

                            <div class = "row-fluid" >
                              <div class = "span5" >
                                <select ng-disabled = "formDisabled"
                                        ng-model = "lossAndAdjustment.type"
                                        ng-options = "i as i.description for i in lossesAndAdjustmentTypesToDisplay" >
                                  <option value = "" >--Select Type--</option >
                                </select >
                              </div >
                              <div class = "span3" >
                                <input ng-disabled = "formDisabled" type = "text"
                                       name = "quantity{{rnrLineItem.id}}"
                                       ng-model = "lossAndAdjustment.quantity"
                                       rnr-validator = "positiveInteger" prevent-rnr-error = "true" maxlength = "8"
                                       placeholder = "Quantity" />

                                <div class = "rnr-form-error"
                                     id = "quantity{{rnrLineItem.id}}"
                                     style = "display:none;" >
                                  Enter Numeric Data
                                </div >
                              </div >
                              <div class = "span4" >
                                <input type = "button"
                                       ng-click = "addLossAndAdjustment(rnrLineItem,lossAndAdjustment)"
                                       ng-disabled = "!(lossAndAdjustment.type && lossAndAdjustment.quantity)"
                                       class = "btn btn-primary" value = "Add" />
                              </div >
                            </div >


                          </div >
                          <hr ng-show = "rnrLineItem.lossesAndAdjustments.length > 0" />
                          <div class = "adjustment-list"
                               ng-show = "rnrLineItem.lossesAndAdjustments.length > 0" >
                            <ul >
                              <li ng-repeat = "oneLossAndAdjustment in rnrLineItem.lossesAndAdjustments"
                                  class = "clearfix" >
                                <span class = "tpl-adjustment-type" >
                                  {{oneLossAndAdjustment.type.description}}
                                </span >
                                <span class = "tpl-adjustment-delete" >
                                  <a class = "close" ng-show = "!formDisabled"
                                     ng-click = "removeLossAndAdjustment(rnrLineItem,oneLossAndAdjustment)" >&times;</a >
                                </span >
                                <span class = "tpl-adjustment-qty" >
                                  <input ng-required = "true"
                                         ng-disabled = "formDisabled"
                                         id = "{{getId('D', $parent, true)}}"
                                         name = "{{oneLossAndAdjustment.type.displayOrder}}"
                                         type = "text"
                                         ng-model = "oneLossAndAdjustment.quantity"
                                         ng-change = "rnrLineItem.reEvaluateTotalLossesAndAdjustments(); resetModalError()"
                                         rnr-validator = "positiveInteger"
                                         maxlength = "8"
                                         ng-class = "highlightRequiredFieldInModal(oneLossAndAdjustment.quantity)"
                                         data-keyboard = "false"
                                    />

                                  <div class = "rnr-form-error"
                                       id = "{{oneLossAndAdjustment.type.displayOrder}}"
                                       style = "display:none;" >
                                    Enter Numeric Data
                                  </div >
                                </span >
                              </li >
                            </ul >
                          </div >

                          <div class = "adjustment-total clearfix alert alert-warning"
                               ng-show = "rnrLineItem.lossesAndAdjustments.length > 0" >
                            <span
                              class = "pull-left" >Total</span > {{rnrLineItem.totalLossesAndAdjustments}}
                          </div >
                          <div class = "alert alert-danger" id = "modalErrorMessage"
                               ng-model = "modalError"
                               ng-show = "rnrLineItem.lossesAndAdjustments.length > 0 && modalError" >
                            {{modalError}}
                          </div >
                        </div >
                        <div class = "modal-footer" >

                          <input type = "button" class = "btn btn-success save-button"
                                 ng-click = "saveLossesAndAdjustmentsForRnRLineItem(rnrLineItem, rnr, programRnRColumnList)"
                                 value = "Done" />
                        </div >
                      </div >
                      <div
                        ng-class = "highlightNestedFieldsWithError(rnrLineItem[column.name], 'quantity')" >
                        <a ng-click = "showLossesAndAdjustmentModalForLineItem(rnrLineItem)"
                           class = "rnr-adjustment" >
                          <span class = "adjustment-value" >
                            {{rnrLineItem.totalLossesAndAdjustments}}</span >
                        </a >
                      </div >
                    </span >


                    <span ng-switch-when = "stockInHand"
                          ng-class = "getCellErrorClass(rnrLineItem, programRnRColumnList)" >
                      <input ng-required = "true" ng-disabled = "formDisabled"
                             id = "{{getId('E', $parent)}}" type = "text"
                             name = "stockInHand{{rnrLineItem['id']}}"
                             ng-model = "rnrLineItem[column.name]"
                             rnr-validator = "positiveInteger"
                             ng-change = "rnrLineItem.fill(rnr, programRnRColumnList)" maxlength = "8"
                             ng-class = "highlightRequired(rnrLineItem[column.name])" />
                      <span class = "rnr-form-error" id = "stockInHand{{rnrLineItem['id']}}"
                            style = "display:none;" >
                        Enter Numeric Data
                      </span >
                      <span class = "row-specific-error" ng-show = "rnrLineItem.getErrorMessage(programRnRColumnList)"
                            style = "background: red;" >
                        {{rnrLineItem.getErrorMessage(programRnRColumnList)}}
                        <span class = "beak-down" ></span >
                      </span >
                    </span >

                    <span ng-switch-when = "newPatientCount" >
                      <input ng-required = "true" ng-disabled = "formDisabled" id = "{{getId('F', $parent)}}"
                             type = "text"
                             name = "newPatientCount{{rnrLineItem['id']}}"
                             ng-model = "rnrLineItem[column.name]"
                             rnr-validator = "positiveInteger" maxlength = "8"
                             ng-change = "rnrLineItem.fill(rnr, programRnRColumnList)"
                             ng-class = "highlightRequired(rnrLineItem[column.name])" />
                      <span class = "rnr-form-error" id = "newPatientCount{{rnrLineItem['id']}}"
                            style = "display:none;" >
                        Enter Numeric Data
                      </span >
                    </span >

                    <span ng-switch-when = "quantityRequested" >
                      <input ng-disabled = "formDisabled" id = "{{getId('J', $parent)}}" type = "text"
                             name = "quantityRequested{{rnrLineItem['id']}}"
                             ng-model = "rnrLineItem[column.name]"
                             rnr-validator = "positiveInteger" maxlength = "8"
                             ng-change = "fill(rnr, programRnRColumnList)" />
                      <span class = "rnr-form-error" id = "quantityRequested{{rnrLineItem['id']}}"
                            style = "display:none;" >
                        Enter Numeric Data
                      </span >
                    </span >

                    <span ng-switch-when = "quantityApproved" >
                      <input id = "{{getId('K', $parent)}}" type = "text"
                             name = "quantityApproved{{rnrLineItem['id']}}"
                             ng-model = "rnrLineItem[column.name]"
                             rnr-validator = "positiveInteger" maxlength = "8" />
                      <span class = "rnr-form-error" id = "quantityApproved{{rnrLineItem['id']}}"
                            style = "display:none;" >
                        Enter Numeric Data
                      </span >
                    </span >

                    <span ng-switch-when = "remarks" >
                      <input ng-disabled = "formDisabled" id = "{{getId('L', $parent)}}" type = "text"
                             name = "remarks{{rnrLineItem['id']}}"
                             ng-model = "rnrLineItem[column.name]"
                             maxlength = "250" />
                    </span >


                    <span ng-switch-when = "reasonForRequestedQuantity" >
                      <input ng-disabled = "formDisabled" id = "{{getId('W', $parent)}}" type = "text"
                             name = "reasonForRequestedQuantity{{rnrLineItem['id']}}"
                             ng-model = "rnrLineItem[column.name]"
                             ng-required = "rnrLineItem.quantityRequested"
                             ng-class = "highlightWarning(rnrLineItem[column.name],$parent.$parent.$parent.$index )"
                             maxlength = "250" />
                      <span class = "alert alert-warning reason-request"
                            ng-show = "rnrLineItem.quantityRequested && !rnrLineItem.reasonForRequestedQuantity" >
                        Please enter a reason
                      </span >
                    </span >

                    <span ng-switch-when = "stockOutDays" >
                      <input ng-required = "true" ng-disabled = "formDisabled" id = "{{getId('X', $parent)}}"
                             type = "text" name = "stockOutDays{{rnrLineItem['id']}}"
                             ng-model = "rnrLineItem[column.name]"
                             rnr-validator = "positiveInteger" maxlength = "8"
                             ng-change = "rnrLineItem.fill(rnr, programRnRColumnList)"
                             ng-class = "highlightRequired(rnrLineItem[column.name])" />
                      <span class = "rnr-form-error" id = "stockOutDays{{rnrLineItem['id']}}"
                            style = "display:none;" >
                        Enter Numeric Data
                      </span >
                    </span >
                  </ng-switch >
                </span >
                <span ng-switch-default >
                  <ng-switch on = "column.name" >
                    <span ng-switch-when = "stockInHand"
                          ng-class = "getCellErrorClass(rnrLineItem, programRnRColumnList)" >
                      <span id = "{{column.indicator+'_'+$parent.$parent.$index}}"
                            ng-bind = "rnrLineItem[column.name]"
                            class = "cell-text" >
                      </span >
                      <span class = "row-specific-error" ng-show = "rnrLineItem.getErrorMessage(programRnRColumnList)"
                            style = "background: red;" >
                        {{rnrLineItem.getErrorMessage(programRnRColumnList)}}
                        <span class = "beak-down" ></span >
                      </span >
                    </span >
                    <span ng-switch-when = "price" >
                      <span id = "{{'priceCurrency_'+$parent.$parent.$index}}" class = "cell-text"
                            ng-show = "showCurrencySymbol(rnrLineItem[column.name])" >
                        {{currency}}
                      </span >
                      <span id = "{{column.indicator+'_'+$parent.$parent.$index}}"
                            ng-bind = "rnrLineItem[column.name]"
                            class = "cell-text" >
                      </span >
                    </span >
                    <span ng-switch-when = "cost" >
                      <span id = "{{'costCurrency_'+$parent.$parent.$index}}" class = "cell-text"
                            ng-show = "showCurrencySymbol(rnrLineItem[column.name])" >
                        {{currency}}
                      </span >
                      <span id = "{{column.indicator+'_'+$parent.$parent.$index}}"
                            ng-bind = "rnrLineItem[column.name]"
                            class = "cell-text" >
                      </span >
                    </span >
                    <span id = "{{column.indicator+'_'+$parent.$parent.$index}}"
                          ng-bind = "rnrLineItem[column.name]"
                          class = "cell-text" ng-switch-default >
                    </span >
                  </ng-switch >
                </span >
              </ng-switch >
            </td >
          </tr >
        </tbody >
      </table >
    </div >
    <br />

    <input type = "button" ng-click = "nonFullSupplyProductsModal=true" value = "Add Non-Full Supply"
           ng-show = "nonFullSupplyProducts.length > 0" />
    <!--start-->
    <div id = "nonFullSupplyProductsModal"
         ng-model = "nonFullSupplyProductsModal"
         class = "fade ng-pristine ng-valid modal hide "
         ui-modal
         data-backdrop = "static" data-keyboard = "false" >
      <div class = "modal-header" ><h3 >Add Non-Full Supply Products</h3 ></div >
      <div class = "modal-body" >
        <select id = "nonFullSupplyProducts" >
          <option ng-repeat = "product in nonFullSupplyProducts" >{{product.programProduct.product.code}}
          </option >
        </select >
      </div >
      <div class = "modal-footer" >
        <a href = "" class = "btn btn-primary" ng-click = "activeConfirmModal=true" data-dismiss = "modal" >Add</a >
        <a href = "" class = "btn" data-dismiss = "modal" >Cancel</a >
      </div >
    </div >
    <!--end-->

    <div id = "action_buttons" class = "action-buttons" >
      <div class = "form-cell button-row" >
        <input ng-disabled = "formDisabled" type = "button" ng-click = "saveRnr()" class = "btn btn-primary save-button"
               value = "Save" />
        <input ng-show = "rnr.status == 'INITIATED' && hasPermission('CREATE_REQUISITION')" ng-disabled = "formDisabled"
               type = "button" ng-click = "submitRnr()" class = "btn btn-success submit-button" value = "Submit" />
        <input type = "button"
               ng-show = "(rnr.status == 'SUBMITTED' || rnr.status == 'AUTHORIZED') && hasPermission('AUTHORIZE_REQUISITION')"
               ng-disabled = "rnr.status == 'AUTHORIZED'" ng-click = "authorizeRnr()"
               class = "btn btn-success submit-button"
               value = "Authorize" />
      </div >
      <div class = "toolbar-error" id = "saveFailMessage" ng-bind = "error"
           ng-show = "error && !submitError && !submitMessage" ></div >
      <div class = "toolbar-error" id = "submitFailMessage" ng-bind = "submitError" ng-show = "submitError" ></div >
      <div class = "toolbar-success" id = "saveSuccessMsgDiv" ng-bind = "message"
           ng-show = "!submitMessage && !submitError && message" ></div >
      <div class = "toolbar-success" id = "submitSuccessMsgDiv" ng-bind = "submitMessage"
           ng-show = "submitMessage" ></div >
    </div >
  </form >
</div >
